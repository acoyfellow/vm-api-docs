#!/bin/bash
# secrets-guard - Global git push guard for sensitive data
#
# Usage:
#   secrets-guard install          Install global pre-push hook
#   secrets-guard add <pattern>    Add a pattern to block
#   secrets-guard list             Show current patterns
#   secrets-guard test             Test against staged changes
#   secrets-guard scan [dir]       Scan a directory for secrets

set -euo pipefail

HOOKS_DIR="$HOME/.config/git/hooks"
PATTERNS_FILE="$HOME/.config/shelley/secrets-patterns.txt"

cmd_install() {
  mkdir -p "$HOOKS_DIR"
  mkdir -p "$(dirname "$PATTERNS_FILE")"
  
  cat > "$HOOKS_DIR/pre-push" << 'HOOK'
#!/bin/bash
SECRETS_FILE="$HOME/.config/shelley/secrets-patterns.txt"

if [ ! -f "$SECRETS_FILE" ]; then
  exit 0
fi

echo "ðŸ” Scanning for secrets before push..."

while read local_ref local_sha remote_ref remote_sha; do
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi
  
  while IFS= read -r pattern; do
    [ -z "$pattern" ] && continue
    [[ "$pattern" =~ ^# ]] && continue
    
    matches=$(git diff "$range" 2>/dev/null | grep -iE "$pattern" | head -5)
    if [ -n "$matches" ]; then
      echo ""
      echo "ðŸš¨ BLOCKED: Found sensitive pattern '$pattern'"
      echo "Matches:"
      echo "$matches"
      echo ""
      echo "To bypass (emergency only): git push --no-verify"
      exit 1
    fi
  done < "$SECRETS_FILE"
done

echo "âœ… No secrets detected"
HOOK

  chmod +x "$HOOKS_DIR/pre-push"
  git config --global core.hooksPath "$HOOKS_DIR"
  
  # Create default patterns file if not exists
  if [ ! -f "$PATTERNS_FILE" ]; then
    cat > "$PATTERNS_FILE" << 'PATTERNS'
# secrets-patterns.txt
# One regex pattern per line. Lines starting with # are comments.

# Common API key patterns
ghp_[a-zA-Z0-9]{36}
sk-[a-zA-Z0-9]{48}
sk-proj-[a-zA-Z0-9]+
AKIA[0-9A-Z]{16}

# Add your personal patterns below:
PATTERNS
  fi
  
  echo "âœ… Global pre-push hook installed"
  echo "   Hooks: $HOOKS_DIR"
  echo "   Patterns: $PATTERNS_FILE"
  echo ""
  echo "Add patterns with: secrets-guard add 'your@email\\.com'"
}

cmd_add() {
  local pattern="$1"
  echo "$pattern" >> "$PATTERNS_FILE"
  echo "âœ… Added pattern: $pattern"
}

cmd_list() {
  if [ -f "$PATTERNS_FILE" ]; then
    echo "Patterns in $PATTERNS_FILE:"
    echo ""
    cat "$PATTERNS_FILE"
  else
    echo "No patterns file. Run: secrets-guard install"
  fi
}

cmd_test() {
  if [ ! -f "$PATTERNS_FILE" ]; then
    echo "No patterns file. Run: secrets-guard install"
    exit 1
  fi
  
  echo "Testing staged changes..."
  local found=0
  
  while IFS= read -r pattern; do
    [ -z "$pattern" ] && continue
    [[ "$pattern" =~ ^# ]] && continue
    
    matches=$(git diff --cached 2>/dev/null | grep -iE "$pattern" | head -5)
    if [ -n "$matches" ]; then
      echo "ðŸš¨ Pattern '$pattern' matched:"
      echo "$matches"
      found=1
    fi
  done < "$PATTERNS_FILE"
  
  if [ $found -eq 0 ]; then
    echo "âœ… No secrets found in staged changes"
  fi
}

cmd_scan() {
  local dir="${1:-.}"
  
  if [ ! -f "$PATTERNS_FILE" ]; then
    echo "No patterns file. Run: secrets-guard install"
    exit 1
  fi
  
  echo "Scanning $dir..."
  local found=0
  
  while IFS= read -r pattern; do
    [ -z "$pattern" ] && continue
    [[ "$pattern" =~ ^# ]] && continue
    
    matches=$(grep -rE "$pattern" "$dir" --include="*.ts" --include="*.js" --include="*.md" --include="*.json" --include="*.sh" --include="*.html" --include="*.env*" 2>/dev/null | grep -v node_modules | grep -v ".git" | head -10)
    if [ -n "$matches" ]; then
      echo ""
      echo "ðŸš¨ Pattern '$pattern':"
      echo "$matches"
      found=1
    fi
  done < "$PATTERNS_FILE"
  
  if [ $found -eq 0 ]; then
    echo "âœ… No secrets found"
  fi
}

cmd_help() {
  cat << 'HELP'
secrets-guard - Global git push guard for sensitive data

Commands:
  install         Install global pre-push hook
  add <pattern>   Add a regex pattern to block
  list            Show current patterns
  test            Test against staged changes  
  scan [dir]      Scan a directory for secrets

Examples:
  secrets-guard install
  secrets-guard add 'myemail@example\.com'
  secrets-guard add 'LOCATION_ID_[A-Za-z0-9]+'
  secrets-guard scan ~/myproject
  secrets-guard test
HELP
}

case "${1:-help}" in
  install) cmd_install ;;
  add) cmd_add "${2:-}" ;;
  list) cmd_list ;;
  test) cmd_test ;;
  scan) cmd_scan "${2:-.}" ;;
  *) cmd_help ;;
esac
